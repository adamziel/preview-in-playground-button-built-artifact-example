name: Clean CI Artifacts

# Run weekly on Sundays at 2am UTC, or manually
on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      artifacts-to-keep:
        description: 'Number of most recent artifacts to keep per open PR (0 = unlimited)'
        required: false
        default: '1'
        type: string

jobs:
  cleanup:
    name: Remove old artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to manage release assets
      pull-requests: read  # Needed to check PR status
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get list of open PRs
        id: open-prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all open PR numbers
          gh pr list --state open --json number --jq '.[].number' > open-prs.txt
          echo "Found $(wc -l < open-prs.txt | tr -d ' ') open PRs"
          cat open-prs.txt

      - name: List and filter artifacts
        id: artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACTS_TO_KEEP: ${{ inputs.artifacts-to-keep || '1' }}
        run: |
          # Check if ci-artifacts release exists
          if ! gh release view ci-artifacts > /dev/null 2>&1; then
            echo "ci-artifacts release does not exist. Nothing to clean up."
            echo "delete_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get all assets with timestamps from the ci-artifacts release
          gh release view ci-artifacts --json assets \
            --jq '.assets[] | "\(.name)|\(.created_at)"' > all-artifacts.txt || true

          if [ ! -s all-artifacts.txt ]; then
            echo "No artifacts found in ci-artifacts release."
            echo "delete_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found $(wc -l < all-artifacts.txt | tr -d ' ') total artifacts"
          echo "Keeping $ARTIFACTS_TO_KEEP most recent artifact(s) per open PR"

          # Create temp directory for per-PR artifact lists
          mkdir -p pr-artifacts
          touch artifacts-to-delete.txt

          # Group artifacts by PR number
          while IFS='|' read -r artifact created_at; do
            if [[ $artifact =~ pr-([0-9]+)- ]]; then
              PR_NUM="${BASH_REMATCH[1]}"

              # Check if this PR is closed
              if ! grep -q "^$PR_NUM$" open-prs.txt; then
                # Closed PR - delete all artifacts
                echo "$artifact" >> artifacts-to-delete.txt
                echo "Will delete: $artifact (PR #$PR_NUM is closed)"
              else
                # Open PR - collect artifacts for later processing
                # Store as "timestamp|artifact" for sorting
                echo "$created_at|$artifact" >> "pr-artifacts/pr-$PR_NUM.txt"
              fi
            else
              echo "Skipping: $artifact (doesn't match PR pattern)"
            fi
          done < all-artifacts.txt

          # Process each open PR's artifacts
          if [ "$ARTIFACTS_TO_KEEP" != "0" ]; then
            for pr_file in pr-artifacts/pr-*.txt; do
              if [ -f "$pr_file" ]; then
                PR_NUM=$(basename "$pr_file" .txt | sed 's/pr-//')

                # Sort by timestamp (newest first) and process
                # The -r flag sorts in reverse order, so ISO 8601 timestamps
                # will be sorted with newest (2025-01-06...) at top, oldest at bottom
                sort -r "$pr_file" > "${pr_file}.sorted"

                # Count artifacts for this PR
                ARTIFACT_COUNT=$(wc -l < "${pr_file}.sorted" | tr -d ' ')
                echo "PR #$PR_NUM has $ARTIFACT_COUNT artifact(s)"

                # Keep the first N (most recent), delete the rest
                CURRENT=0
                while IFS='|' read -r timestamp artifact; do
                  CURRENT=$((CURRENT + 1))
                  if [ $CURRENT -le $ARTIFACTS_TO_KEEP ]; then
                    echo "Keeping: $artifact (PR #$PR_NUM, artifact $CURRENT of $ARTIFACTS_TO_KEEP to keep)"
                  else
                    echo "$artifact" >> artifacts-to-delete.txt
                    echo "Will delete: $artifact (PR #$PR_NUM, older artifact #$CURRENT)"
                  fi
                done < "${pr_file}.sorted"
              fi
            done
          else
            echo "ARTIFACTS_TO_KEEP=0, keeping all artifacts from open PRs"
            # Just list what we're keeping
            for pr_file in pr-artifacts/pr-*.txt; do
              if [ -f "$pr_file" ]; then
                PR_NUM=$(basename "$pr_file" .txt | sed 's/pr-//')
                ARTIFACT_COUNT=$(wc -l < "$pr_file" | tr -d ' ')
                echo "Keeping all $ARTIFACT_COUNT artifact(s) for PR #$PR_NUM"
              fi
            done
          fi

          DELETE_COUNT=$(wc -l < artifacts-to-delete.txt | tr -d ' ')
          echo "Found $DELETE_COUNT artifacts to delete"
          echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT

      - name: Delete old artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ ! -f artifacts-to-delete.txt ] || [ ! -s artifacts-to-delete.txt ]; then
            echo "No artifacts to delete"
            exit 0
          fi

          echo "Deleting artifacts..."
          while IFS= read -r artifact; do
            echo "Deleting: $artifact"
            gh release delete-asset ci-artifacts "$artifact" --yes || echo "Failed to delete $artifact"
          done < artifacts-to-delete.txt

          echo "Cleanup complete!"

      - name: Summary
        env:
          ARTIFACTS_TO_KEEP: ${{ inputs.artifacts-to-keep || '1' }}
        run: |
          echo "### Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** Keeping $ARTIFACTS_TO_KEEP most recent artifact(s) per open PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f artifacts-to-delete.txt ] && [ -s artifacts-to-delete.txt ]; then
            echo "**Deleted ${{ steps.artifacts.outputs.delete_count }} artifact(s):**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r artifact; do
              echo "- \`$artifact\`" >> $GITHUB_STEP_SUMMARY
            done < artifacts-to-delete.txt
          else
            echo "No artifacts needed to be deleted." >> $GITHUB_STEP_SUMMARY
          fi
