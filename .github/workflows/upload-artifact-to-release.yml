name: Upload Artifact to Release with Cleanup
description: |
  Upload artifacts to a single GitHub Release (with automatic cleanup)

  This workflows enables previewing builds in WordPress Playground by
  exposing your selected CI build artifact on a public URL. It uses a
  single GitHub release as a central data store for artifacts from all
  PRs. It also automatically cleans up old artifacts.
  
  ## Prerequisite

    Create a dedicated release first. It's a pre-release and won't be
    displayed in the main releases list:

    ```bash
    gh release create ci-artifacts --title "CI Artifacts" --prerelease
    ```

  ## Usage example (remove the backslashes):
  
    jobs:
      # Build your artifact first
      build:
        runs-on: ubuntu-latest

        # Expose the built artifact path to the upload job
        outputs:
          artifact-path: ${\{ steps.build.outputs.path }}
        steps:
          - uses: actions/checkout@v4
          - name: Build
            id: build
            run: |
              npm run build
              zip -r plugin.zip dist/
              echo "path=$PWD/plugin.zip" >> $GITHUB_OUTPUT
  
      upload:
        # Wait for the build job to finish
        needs: build
        permissions:
          contents: write # Required!
        uses: ./.github/workflows/upload-artifact-to-release.yml

        # Pass the built artifact details to the upload job
        with:
          # Remove those backslashes in your workflow:
          artifact-path: ${\{ needs.build.outputs.artifact-path }}
          pr-number: ${\{ github.event.pull_request.number }}
          commit-sha: ${\{ github.sha }}
          artifacts-to-keep: '2' # Only store the 2 most recent artifacts for
                                 # every PR. Optional. Defaults to 2.

on:
  workflow_call:
    inputs:
      artifact-path:
        description: |
          Path to the artifact file to upload (e.g., 'dist/plugin.zip' or '$PWD/build.zip')

          This should be an absolute or relative path to a zip file containing your built plugin/theme.
          The file will be copied and renamed to: pr-{number}-{sha}.zip

          Example (remove the backslash): ${\{ needs.build.outputs.artifact-path }}
        required: true
        type: string

      pr-number:
        description: |
          Pull request number for unique artifact naming

          Used to create artifacts named: pr-{THIS_NUMBER}-{sha}.zip
          Also used to find and clean up other artifacts for the same PR.

          Example (remove the backslash): ${\{ github.event.pull_request.number }}
        required: true
        type: string

      commit-sha:
        description: |
          Commit SHA for unique artifact naming

          Used to create artifacts named: pr-{number}-{THIS_SHA}.zip
          Ensures each commit gets a unique artifact even if built multiple times.

          Example (remove the backslash): ${\{ github.sha }}
        required: true
        type: string

      artifacts-to-keep:
        description: |
          Number of most recent artifacts to keep for this PR (default: 2)

          After uploading a new artifact, this workflow automatically deletes older
          artifacts for the same PR, keeping only the N most recent.

          Values:
            '1' - Keep only the latest (minimal storage)
            '2' - Keep 2 most recent (default, good for comparing)
            '3' - Keep 3 most recent (useful for testing multiple versions)
            '0' - Keep all artifacts (unlimited, disables cleanup)

          Example: '2'
        required: false
        type: string
        default: '2'

      release-tag:
        description: |
          GitHub release tag to upload artifacts to (default: 'ci-artifacts')

          The release with this tag must already exist. Create it with:
            gh release create ci-artifacts --title "CI Artifacts" --prerelease

          Using a dedicated release keeps your main releases clean while providing
          public URLs for PR artifacts.

          Example: 'ci-artifacts'
        required: false
        type: string
        default: 'ci-artifacts'

    outputs:
      artifact-url:
        description: |
          Public download URL for the uploaded artifact

          Format: https://github.com/{owner}/{repo}/releases/download/{tag}/pr-{number}-{sha}.zip
          This URL can be used directly in Playground blueprints or shared publicly.

          Example: https://github.com/my-org/my-plugin/releases/download/ci-artifacts/pr-123-abc1234.zip
        value: ${{ jobs.upload.outputs.artifact-url }}

      artifact-name:
        description: |
          Filename of the uploaded artifact

          Format: pr-{number}-{sha}.zip
          Useful for logging or debugging purposes.

          Example: pr-123-abc1234.zip
        value: ${{ jobs.upload.outputs.artifact-name }}

jobs:
  upload:
    name: Upload and Cleanup
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to upload assets to releases
    outputs:
      artifact-url: ${{ steps.upload.outputs.url }}
      artifact-name: ${{ steps.upload.outputs.name }}
    steps:
      - name: Upload artifact to release
        id: upload
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr-number }}
          COMMIT_SHA: ${{ inputs.commit-sha }}
          ARTIFACT_PATH: ${{ inputs.artifact-path }}
          RELEASE_TAG: ${{ inputs.release-tag }}
        run: |
          # Create unique filename for this PR and commit
          ARTIFACT_NAME="pr-${PR_NUMBER}-${COMMIT_SHA}.zip"

          # Copy and rename the artifact
          cp "$ARTIFACT_PATH" "$ARTIFACT_NAME"

          # Upload to the release
          echo "Uploading $ARTIFACT_NAME to $RELEASE_TAG release..."
          gh release upload "$RELEASE_TAG" "$ARTIFACT_NAME" \
            --repo ${{ github.repository }} \
            --clobber

          # Get the download URL
          ARTIFACT_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${ARTIFACT_NAME}"

          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          echo "Artifact uploaded to: $ARTIFACT_URL"

      - name: Cleanup old artifacts for this PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr-number }}
          ARTIFACTS_TO_KEEP: ${{ inputs.artifacts-to-keep }}
          RELEASE_TAG: ${{ inputs.release-tag }}
        run: |
          echo "Cleaning up old artifacts for PR #$PR_NUMBER (keeping $ARTIFACTS_TO_KEEP most recent)"

          # Check if cleanup is enabled
          if [ "$ARTIFACTS_TO_KEEP" = "0" ]; then
            echo "ARTIFACTS_TO_KEEP=0, keeping all artifacts for this PR"
            exit 0
          fi

          # Get all artifacts for this PR with timestamps
          gh release view "$RELEASE_TAG" --json assets \
            --jq ".assets[] | select(.name | startswith(\"pr-$PR_NUMBER-\")) | \"\(.created_at)|\(.name)\"" \
            > pr-artifacts.txt || true

          if [ ! -s pr-artifacts.txt ]; then
            echo "No existing artifacts found for PR #$PR_NUMBER"
            exit 0
          fi

          ARTIFACT_COUNT=$(wc -l < pr-artifacts.txt | tr -d ' ')
          echo "Found $ARTIFACT_COUNT total artifact(s) for PR #$PR_NUMBER"

          # If we have fewer artifacts than the limit, nothing to delete
          if [ "$ARTIFACT_COUNT" -le "$ARTIFACTS_TO_KEEP" ]; then
            echo "Artifact count ($ARTIFACT_COUNT) is within limit ($ARTIFACTS_TO_KEEP), no cleanup needed"
            exit 0
          fi

          # Sort by timestamp (newest first)
          sort -r pr-artifacts.txt > pr-artifacts-sorted.txt

          # Process artifacts: keep first N, delete rest
          CURRENT=0
          while IFS='|' read -r timestamp artifact; do
            CURRENT=$((CURRENT + 1))
            if [ $CURRENT -le $ARTIFACTS_TO_KEEP ]; then
              echo "Keeping: $artifact (artifact $CURRENT of $ARTIFACTS_TO_KEEP)"
            else
              echo "Deleting: $artifact (old artifact #$CURRENT)"
              gh release delete-asset "$RELEASE_TAG" "$artifact" --yes || echo "Failed to delete $artifact"
            fi
          done < pr-artifacts-sorted.txt

          echo "Cleanup complete for PR #$PR_NUMBER"
